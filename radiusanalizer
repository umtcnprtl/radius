import os
import pandas as pd
import re
from tabulate import tabulate
from collections import defaultdict

def parse_radius_log(file_path):
    """
    FreeRADIUS log dosyasÄ±nÄ± satÄ±r satÄ±r ayrÄ±ÅŸtÄ±rarak hem kimlik doÄŸrulama,
    hem de hesap (accounting) ve challenge bilgilerini Ã§Ä±karÄ±r.
    """
    if not os.path.exists(file_path):
        print(f"âŒ HATA: Dosya bulunamadÄ±! -> {file_path}")
        return pd.DataFrame(), []

    # defaultdict kullanarak anahtar yoksa otomatik olarak varsayÄ±lan bir deÄŸer atÄ±yoruz.
    sessions = defaultdict(lambda: {"flow": []})
    challenge_entries = []

    with open(file_path, "r", encoding="utf-8", errors='ignore') as file:
        for line in file:
            line = line.strip()

            request_id_match = re.match(r'\((\d+)\)', line)
            if not request_id_match:
                continue

            request_id = request_id_match.group(1)
            sessions[request_id]["request_id"] = request_id

            # --- Olay AkÄ±ÅŸÄ±nÄ± ve Durumunu Belirle ---

            if "Received Access-Request" in line:
                sessions[request_id]['request_type'] = 'Authentication'
                sessions[request_id]['flow'].append('Access-Request')
            elif "Sent Access-Accept" in line:
                sessions[request_id]['status'] = 'Accept'
                sessions[request_id]['flow'].append('Access-Accept')
            elif "Sent Access-Reject" in line:
                sessions[request_id]['status'] = 'Reject'
                sessions[request_id]['flow'].append('Access-Reject')
            elif "Sent Access-Challenge" in line:
                sessions[request_id].setdefault('status', 'Challenge') # EÄŸer baÅŸka status yoksa challenge ata
                sessions[request_id]['flow'].append('Access-Challenge')
                challenge_entries.append(line)

            elif "Received Accounting-Request" in line:
                sessions[request_id]['request_type'] = 'Accounting'
                sessions[request_id]['flow'].append('Accounting-Request')
            elif "Acct-Status-Type" in line:
                status_match = re.search(r'Acct-Status-Type = (.*?)$', line)
                if status_match:
                    status = status_match.group(1).strip()
                    sessions[request_id]['status'] = status
                    sessions[request_id]['flow'].append(f'Acct-{status}')

            # --- Ortak Bilgileri Ã‡Ä±kar ---

            if 'User-Name = "' in line:
                user_match = re.search(r'User-Name = "(.*?)"', line)
                if user_match:
                    sessions[request_id]['user'] = user_match.group(1)
            
            if 'NAS-IP-Address =' in line:
                 nas_ip_match = re.search(r'NAS-IP-Address = (.*?)$', line)
                 if nas_ip_match:
                     sessions[request_id]['nas_ip'] = nas_ip_match.group(1).strip()
            
            if 'NAS-Port-Type =' in line:
                port_type_match = re.search(r'NAS-Port-Type = (.*?)$', line)
                if port_type_match:
                    sessions[request_id]['nas_port_type'] = port_type_match.group(1).strip()

    log_data = list(sessions.values())
    return pd.DataFrame(log_data), challenge_entries


def analyze_radius_logs():
    """
    KullanÄ±cÄ±dan log dosyasÄ±nÄ±n yolunu alÄ±r, analiz eder ve sonuÃ§larÄ± tablo
    ve detaylÄ± dÃ¶kÃ¼m formatÄ±nda yazdÄ±rÄ±r.
    """
    log_file = input("LÃ¼tfen FreeRADIUS log dosyasÄ±nÄ±n tam yolunu girin: ")
    if not os.path.exists(log_file):
        print(f"âŒ HATA: Dosya bulunamadÄ±! -> {log_file}")
        return

    logs_df, challenge_entries = parse_radius_log(log_file)
    if logs_df.empty:
        print("âŒ Log dosyasÄ±nda analiz edilecek veri bulunamadÄ±.")
        return

    # --- GÃ¶rÃ¼ntÃ¼leme iÃ§in DataFrame'i HazÄ±rla ---
    display_columns = [
        "request_id", "request_type", "user", "status", "nas_ip", "nas_port_type"
    ]
    existing_columns = [col for col in display_columns if col in logs_df.columns]
    display_df = logs_df[existing_columns].fillna("N/A")

    print("\nðŸ“Š **FreeRADIUS KapsamlÄ± Log Analizi (Auth & Acct)**\n")
    print(tabulate(display_df, headers="keys", tablefmt="grid"))

    # --- BaÄŸlantÄ± YaÅŸam DÃ¶ngÃ¼sÃ¼nÃ¼ GÃ¶ster ---
    print("\nðŸ”„ **BaÄŸlantÄ± YaÅŸam DÃ¶ngÃ¼sÃ¼:**")
    # Sadece anlamlÄ± bir akÄ±ÅŸÄ± olan satÄ±rlarÄ± al
    lifecycle_df = logs_df[logs_df['flow'].map(lambda x: len(x) > 0)].fillna("Bilinmiyor")
    if lifecycle_df.empty:
        print("  - YaÅŸam dÃ¶ngÃ¼sÃ¼ bilgisi bulunamadÄ±.")
    else:
        for index, row in lifecycle_df.iterrows():
            flow_str = " -> ".join(row['flow'])
            print(f"  - Ä°stek ID: {row['request_id']} | KullanÄ±cÄ±: {row['user']} | Durum: {row['status']}")
            print(f"    SÃ¼reÃ§: {flow_str}")

    # --- Access-Challenge Girdilerini GÃ¶ster ---
    if challenge_entries:
        print("\nì±Œ **Access-Challenge Girdileri:**")
        for entry in challenge_entries:
            print(f"  - {entry}")

if __name__ == "__main__":
    analyze_radius_logs()
